---
output:
  bookdown::word_document2:
    number_sections: false
    global_numbering: true
    reference_docx: "~/HeadRs/rmd_templates/style-guide-arial-11.docx"
bibliography: "`r path.expand('~/Box Sync/papers/EnvEpi.bib')`"
csl: "`r path.expand('~/HeadRs/csl/asa.csl')`"
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = F, results = 'asis',
											tab.cap.tnd = 1)
library(magrittr); library(ggplot2)
library(flextable)
library(data.table)
```

# Results

```{r}
source(here::here("../gm-wrangling/wrangling/table1.R"))
clean.tab1 <- function(tab1) {
	# hspace.which <- grepl("\\\\hspace\\{.*\\}", rownames(tab1))
	rownames(tab1) <- gsub("\\\\hspace\\{.*\\}|\\\\hline |\\$.*\\$| among deceased", "", rownames(tab1))
	
	tab1[!grepl("median", tab1[,4]) & !is.na(tab1[,1]), 2]  <-  paste0(
		"(",
		tab1[!grepl("median", tab1[,4]) & !is.na(tab1[,1]), 2],
		")"
	)
	
	
	tab1[grepl("median", tab1[,4]) & !is.na(tab1[,1]), 2] <- paste0(
		"(", tab1[grepl("median", tab1[,4]) & !is.na(tab1[,1]), 2], ", ",
		tab1[grepl("median", tab1[,4]) & !is.na(tab1[,1]), 3],
		")"
	)
	
	return(tab1[,1:2])
}
full.tab1 <- readRDS(here::here("resources", "tab1.rds"))
nhl.tab1 <- readRDS(here::here("resources", "nhl.tab1.rds"))

tab1.clean <- clean.tab1(full.tab1)
nhl.tab1.clean <- clean.tab1(nhl.tab1)

tab1 <- cbind(hspace.logical = grepl("\\\\hspace\\{.*\\}", rownames(full.tab1)),
							variable = rownames(tab1.clean), tab1.clean, NA, nhl.tab1.clean)

tab1 <- tab1[!grepl("Years of follow-up", rownames(tab1)),]
tab1$variable[1] <- "N (person-years)"
```

Table 1 presents summary statistics of exposure and covariates for the full study population and for those diagnosed with NHL between 1985 and 2005. The cohort is predominantly white (66%) and male (87%). The median year of hire among those diagnosed with NHL was 1959 whereas the median year of hire in the full study population was almost a decade later. Age at hire was approximately the same among those with NHL and the full study population. Median lagged cumulative exposure to all three MWF types was higher among NHL cases. Soluble MWFs were the most widely used MWF type, with approximately 90% of workers ever exposed. Median cumulative exposure 
among the exposed was 6.5 times higher for soluble than for straight MWFs. Figure 2 shows median average annual exposure to the three MWF types among exposed workers over calendar time. Exposure to MWF generally followed a downward trend over time.

```{r}
# tab1 <- tab1[tab1.which,]
tab1[,-grep("hspace.logical", colnames(tab1))] |> 
	data.frame() |> flextable() |>
	delete_part(part = "header") |>
	add_header_row(values = c("", "Study population", "", "NHL cases"),
								 colwidths = c(1, 2, 1, 2)) |>
	hline_top(part = "header") |>
	hline_top() |> hline_bottom() |>
	hline(which((grepl("[0-9]\\)", tab1$spread))[-1])[1]) |> width(4, 0.1) |>
	width(1, 2.2) |> width(c(3, 6), 1.1) |> width(c(2, 5), 0.65) |>
	flextable::compose(
		i = grep("Cumulative exposure", rownames(tab1)), j = 1,
		value = as_paragraph("Cumulative exposure to MWFs (mg/m",
												 as_sup("3"), "-years)")) |>
	flextable::align(j = 2:6, align = "center", part = "all") |>
	footnote(i = grep("Plant$", rownames(tab1)), j = 1, value = as_paragraph(
		" Plant of longest employment duration among those who worked at multiple plants"),
		ref_symbols = "a", inline = T) |>
	footnote(i = grep("Ever exposed|time off", rownames(tab1)), j = 1, value = as_paragraph(
		" Lagged 10 years"),
		ref_symbols = "b", inline = T) |>
	footnote(i = grep("work", rownames(tab1)), j = 1, value = as_paragraph(
		" Among those who left work by December 31, 1994"),
		ref_symbols = "c", inline = T) |>
	# footnote(i = grep("death", rownames(tab1)), j = 1, value = as_paragraph(
	# 	" Among deceased"),
	# 	ref_symbols = "d", inline = T) |>
	footnote(i = grep("Cumulative exposure", rownames(tab1)), j = 1, value = as_paragraph(
		" Among ever-exposed individuals, lagged 10 years."),
		ref_symbols = "d", inline = T) |>
	add_footer_row(values = "NHL: non-Hodgkin lymphoma.", colwidths = 6) |>
	padding(padding = 1.5, part = "all") |>
	padding(
		i = which(tab1$hspace.logical),
		j = 1,
		padding.left = 20
	) |>
	merge_at(i = grep("Cumulative exposure", rownames(tab1))) |>
	hline_bottom(part = "footer") |> font(fontname = 'arial') |>
	set_caption(caption = "Summary of population characteristics. Statistics shown above the horizontal line are count (%). Those shown below are median (quartile 1, quartile 3).")
```
\

![Figure 2. Median average annual exposure to soluble, straight, and synthetic metalworking fluids among exposed workers over time.](`r here::here("resources/images", "exposure.png")`){width=6.5in}

```{r}
intervened_py <- readRDS(here::here("resources", "percent-py-intervened.rds"))
# paste(paste0("\"", intervened_py$dt.name, "\""), collapse = ",\n") |> clipr::write_clip()
dat.names <- data.table(
	dt.name = c(
		"dat.sol.reduced", "dat.sol.reduced2", "dat.sol.reduced10"),
	variable.dat = c(
		"soluble", "soluble2", "soluble10")
)
intervened_py <- as.data.table(merge(
	intervened_py, dat.names,
	by = "dt.name"))
intervened_py <- rbindlist(list(
	data.table(dt.name = NA,
						 mwf = NA, percent_py_intervened = 0,
						 variable.dat = "natural"),
	intervened_py
))
```

```{r}
load(here::here("resources", paste0("h.estimates.rdata")))
estimates.bs <- readRDS(here::here("resources", paste0("estimates.bs.rds")))
```

```{r}
# Risk ratios
do.call(cbind, lapply(estimates.bs[,-(1:2)], function(x) {
	x/estimates.bs[,2]
})) %>% melt(measure.vars = names(.)) -> rr.bs

# Risk differences
do.call(cbind, lapply(estimates.bs[,-(1:2)], function(x) {
	x - estimates.bs[,2]
})) %>% melt(measure.vars = names(.)) -> rd.bs

estimates.bs[,-1] %>% melt(measure.vars = names(.)) -> risk.bs

# Collect point estimates
point_estimates <- data.table(
	variable = c(
		"soluble", "soluble2", "soluble10", "natural"),
	estimate = c(
		h.reduction.sol, h.reduction.sol2, h.reduction.sol10,
		h.baseline)
)
```
```{r}
# Calculate risk ratios for each bootstrap sample
rr <- merge(
	rr.bs,
	point_estimates[,.(
		variable = paste0(variable, ".natural"),
		estimate = estimate/estimate[variable == "natural"]
	)],
	all.x = F,
	by = "variable")

# Get lower and upper 2.5th %tiles
rr <- rr[,.(
	rr = estimate[1],
	rr_lower = {
		x <- value
		x[!is.na(x)] <- 2 * mean(x[!is.na(x)]) - quantile(x[!is.na(x)], 1 - 0.025)},
	rr_upper = {
		x <- value
		x[!is.na(x)] <- 2 * mean(x[!is.na(x)]) - quantile(x[!is.na(x)], 0.025)}
	# wald.lower = exp(log(estimate[1]) + qnorm(0.025) * sd(log(value))),
	# wald.upper = exp(log(estimate[1]) - qnorm(0.025) * sd(log(value)))
),
variable]
```
```{r}
# Calculate risk differences for each bootstrap sample
rd <- merge(
	rd.bs,
	point_estimates[,.(
		variable = paste0(variable, ".natural"),
		estimate = estimate - estimate[variable == "natural"]
	)],
	all.x = F,
	by = "variable")

# Get lower and upper 2.5th %tiles
rd <- rd[,.(
	rd = estimate[1],
	rd_lower = {
		x <- value
		x[!is.na(x)] <- 2 * mean(x[!is.na(x)]) - quantile(x[!is.na(x)], 1 - 0.025)},
	rd_upper = {
		x <- value
		x[!is.na(x)] <- 2 * mean(x[!is.na(x)]) - quantile(x[!is.na(x)], 0.025)}
	# wald.lower = exp(log(estimate[1]) + qnorm(0.025) * sd(log(value))),
	# wald.upper = exp(log(estimate[1]) - qnorm(0.025) * sd(log(value)))
),
variable]

rd[,(c('rd', 'rd_lower', 'rd_upper')) := list(
	- rd * 34734,
	- rd_upper * 34734,
	- rd_lower * 34734
	)]

```

```{r}
# Combine differences and ratios
contrasts.tab <- merge(rr, rd, by = 'variable')
```

```{r}
# Collect risks
risks <- merge(
	risk.bs,
	point_estimates,
	all.x = F,
	by = "variable")

# Get lower and upper 2.5th %tiles
risks <- risks[,.(estimate = estimate[1],
			lower = {
				x <- value
				x[!is.na(x)] <- 2 * mean(x[!is.na(x)]) - quantile(x[!is.na(x)], 1 - 0.025)},
			upper = {
				x <- value
				x[!is.na(x)] <- 2 * mean(x[!is.na(x)]) - quantile(x[!is.na(x)], 0.025)}
			# wald.lower = exp(log(estimate[1]) + qnorm(0.025) * sd(log(value))),
			# wald.upper = exp(log(estimate[1]) - qnorm(0.025) * sd(log(value)))
			),
	 .(variable.risks = variable)]
```

```{r}
intervention.labels <- data.table(
	variable = c(
		"natural", "soluble", "soluble2", "soluble10"
	),
	label = c(
		"None", "0.5", "0.25", "0.05"
	)
)

# Add intervention labels
contrasts.tab <- merge(
	contrasts.tab, intervention.labels[,.(variable = paste0(variable, ".natural"), label)],
	all = T,
	by = "variable"
)

```

```{r}
clean_percent_py <- function(variable, digits = 1, scale = 100) {
	sprintf(paste0("%.", digits, "f"), round(
		intervened_py[match(
	 		sapply(variable, gsub, pattern = ".natural", replacement = ""),
	 		variable.dat
	), percent_py_intervened] * scale,
	digits))
}

clean_risk <- function(variable, digits = 2, scale = 1000) {
	sprintf(paste0("%.", digits, "f"), round(risks[match(
	 		sapply(variable, gsub, pattern = ".natural", replacement = ""),
	 		variable.risks
	), estimate] * scale, digits))
}

clean_risk.ci <- function(variable, digits = 2, scale = 1000) {
	 		x <- risks[match(
	 		sapply(variable, gsub, pattern = ".natural", replacement = ""),
	 		variable.risks
	 		),.(lower, upper)]
	 		ifelse(!is.na(x$lower), paste0(
	 			"(",
	 			sprintf(paste0("%.", digits, "f"), round(x$lower * scale, digits)),
	 			", ", 
	 			sprintf(paste0("%.", digits, "f"), round(x$upper * scale, digits)),
	 			")"), NA)
}

clean_rr.ci <- function(estimate, lower, upper, digits = 2) {
	ifelse(!is.na(lower), paste0(
		"(",
		sprintf(paste0("%.", digits, "f"), round(lower, digits)),
		", ",
		sprintf(paste0("%.", digits, "f"), round(upper, digits)),
		")"), NA)
}

mwf.flextable <- function(x, n_col = 8) {
	flextable::compose(x, j = c(4, n_col), value = as_paragraph(rep("(95% CI)", 2)),
		part = "header"
	) |>
	border_remove() |>
	hline_top(part = "header") |>
	hline_top() |> hline_bottom() |>
	flextable::align(j = 2:n_col, align = "center", part = "all") |>
	width(width = c(1.7, 1.1, 0.7, 1, 0.5, 1, 0.5, 1)) |>
	padding(padding = 1.5, part = "all")
}
```

The observed risk of NHL over the 20-year follow-up period was 231 per 34,734 (6.65 per 1000). Table 2 presents the hazard-extended ICE parametric g-formula estimates of the counterfactual risk, risk difference, and risk ratios contrasting hypothetical limits on exposure to soluble MWF to no limit, after elimination of competing risks. Under an intervention eliminating competing risks, the estimated risk under no limit on MWF exposure was 332 (285, 380) per 34,734. Stronger limits on average annual exposure to soluble MWFs resulted in monotonically stronger reductions in the risk of NHL. Capping average annual exposure to soluble MWFs at 0.5 mg/m^3^, 0.25 mg/m^3^, and 0.05 mg/m^3^ resulted in 44 (-6, 91), 52 (-5, 106), and 71 (12, 129) fewer NHL cases, respectively. These correspond to risk ratios 0.87 (0.73, 1.02), 0.84 (0.68, 1.01), and 0.79 (0.61, 0.97).

```{r, eval=F}
tikzDevice::tikz(here::here("reports/ACIC (2022)/poster/resources/rr.tex"),
								 width = 4, height = 1.75,
								 standAlone = T)
contrasts.tab[grepl("sol|natural\\.natural", variable) & !grepl(
	"[a-z]", label),] |> ggplot(
		aes(x = factor(label, rev(c("0.5", "0.25", "0.05"))),
				y = rd, ymin = rd_lower, ymax = rd_upper)
	) +
	geom_errorbar(linewidth = 0.5, width = 0.15, color = '#102451') +
	geom_point(size = 0.9, color = '#102451') + 
	geom_hline(yintercept = 1, lty = 2, color = '#102451', alpha = 0.7) +
	labs(
		y = "Cases averted",
		x = "Hypothetical limit (mg/m$^3$)") +
	mytheme +
	coord_flip(ylim = c(-15, 130)) +
	theme(panel.grid = element_blank())
dev.off()

lualatex(directory = here::here("reports/ACIC (2022)/poster/resources"))
```

```{r}
contrasts.tab[grepl("sol|natural\\.natural", variable),.(
	 	label,
	 	`Person-years intervened (%)` = clean_percent_py(variable),
	 	`Risk`  = clean_risk(variable, 0, 34734),
	 	`(Risk 95% CI)`      = clean_risk.ci(variable, 0, 34734),
	 	`RD`    = round(rd),
	 	`(RD 95% CI)`        = c(NA, paste0(
	 		"(",
	 		round(na.exclude(rd_lower)), ", ",
	 		round(na.exclude(rd_upper)), ")")),
	 	RR              = sprintf("%.2f", round(rr, 2)),
	 	`(RR 95% CI)`   = clean_rr.ci(rr, rr_lower, rr_upper)
	 )][c(1, 2, 4, 3),] -> sol.tab

sol.tab[sol.tab == "NA"] <- NA
# saveRDS(sol.tab, here::here('resources', 'sol.tab.rds'))

sol.tab |> flextable() |>
	flextable::compose(j = 1, value = as_paragraph(
				"Exposure limit (mg/m", as_sup("3"), ")"),
		part = "header"
	) |> mwf.flextable() |>
	width(width = c(1.1, 1.1, 0.5, 0.9, 0.45, 0.9, 0.55, 0.9)) |>
	add_footer_row(values = paste(
		"Note. Counterfactual risk and risk difference estimates were expressed per 34,734.",
		"MWF: metalworking fluid",
		sep = "\n"), colwidths = 8) |>
	hline_bottom(part = "footer") |>
	set_caption(caption = "Counterfactual risk, risk difference, and risk ratio estimates contrasting interventions on soluble MWF to the observed course.")
	
```